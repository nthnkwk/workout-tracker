<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Workout" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />
  <title>Workout Tracker</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; background: #fff; max-width: 430px; margin: 0 auto; min-height: 100vh; }
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; }
    .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 100; display: flex; align-items: flex-end; }
    .sheet { background: #fff; width: 100%; border-radius: 20px 20px 0 0; padding: 24px 20px 48px; max-height: 80vh; overflow-y: auto; }
    .sheet-handle { width: 36px; height: 4px; background: #ddd; border-radius: 99px; margin: 0 auto 20px; }
    .tab-bar { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); border-top: 1px solid #eee; display: flex; padding: 10px 0 env(safe-area-inset-bottom, 16px); }
    .tab-btn { flex: 1; background: none; border: none; cursor: pointer; padding: 6px 0; display: flex; flex-direction: column; align-items: center; gap: 2px; position: relative; }
    .tab-badge { position: absolute; top: 4px; right: calc(50% - 18px); width: 8px; height: 8px; border-radius: 50%; background: #0eb8a0; }
    .page { padding: 0 20px 110px; }
    .section-label { font-size: 12px; font-weight: 700; color: #0c6b5e; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 12px; }
    .pbar-wrap { background: #f0f0f0; border-radius: 99px; height: 6px; overflow: hidden; }
    .pbar-fill { height: 100%; border-radius: 99px; transition: width 0.4s; }
    .tip-num { background: linear-gradient(135deg,#6be53d,#0eb8a0); color: #fff; border-radius: 99px; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; flex-shrink: 0; margin-top: 1px; }
    .tag { font-size: 10px; border-radius: 6px; padding: 2px 7px; font-weight: 600; display: inline-block; }
    .deload-tag { background: #fff3cd; color: #92400e; }
    .optional-tag { background: #f0f0f0; color: #888; }
    .card-grad-subtle { background: linear-gradient(135deg, rgba(107,229,61,0.12) 0%, rgba(14,184,160,0.12) 100%); }
  </style>
</head>
<body>
<div id="app"></div>
<script>

// â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const T = {
  grad: "linear-gradient(315deg,#6be53d,#0eb8a0)",
  gradSubtle: "linear-gradient(135deg,rgba(107,229,61,0.12),rgba(14,184,160,0.12))",
  teal: "#0eb8a0", green: "#6be53d", mid: "#22c97a",
  dark: "#0a3d35", accent: "#0c6b5e",
  glow: "0 0 32px rgba(34,201,122,0.22), 0 4px 24px rgba(14,184,160,0.15)",
  glowSm: "0 0 16px rgba(34,201,122,0.15)",
};

const WEEK_GRADS = {
  1:"linear-gradient(315deg,#a8ed6a,#2dd4a0)",
  2:"linear-gradient(315deg,#96e84a,#1fc99a)",
  3:"linear-gradient(315deg,#7de02a,#18bc8e)",
  4:"linear-gradient(315deg,#5ed800,#12a87e)",
  5:"linear-gradient(315deg,#44cc00,#0e9870)",
  6:"linear-gradient(315deg,#2ebd00,#0a8862)",
  7:"linear-gradient(315deg,#fde68a,#fbbf24)",
};

// â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DAYS = {
  A:{ label:"Day A", subtitle:"Upper Chest + Lats", exercises:[
    {id:"incline_db",name:"Incline DB Press",range:"4Ã—6â€“8",unit:"kg",tips:["Set bench to 30â€“45Â°. Higher = more shoulder, lower = more chest.","Dumbbells start at shoulder height, elbows at ~60Â° from torso (not flared out).","Press up and slightly together â€” don't lock out hard at top.","Control the descent for 2â€“3 sec. Feel the stretch at the bottom.","Stop 1â€“2 reps before form breaks â€” no ugly grinding."]},
    {id:"pullups",name:"Pull-Ups",range:"4Ã—5â€“8",unit:"BW",tips:["Dead hang start â€” full arm extension, shoulders packed down.","Drive elbows toward your back pockets, not just down.","Chin clears bar = full rep. Don't crane your neck up.","Lower slowly (2â€“3 sec) â€” the descent builds more muscle.","If stuck at low reps: use a band or do 3-sec negatives only."]},
    {id:"cs_row",name:"Chest Supported Row",range:"3Ã—8â€“10",unit:"kg",tips:["Lie chest-down on the incline pad â€” let your arms hang freely.","Row to your lower chest/upper stomach, not your chin.","Squeeze shoulder blades together at the top, hold 1 sec.","Elbows should travel at ~45Â° from body â€” not straight out.","Keep your chest pinned to the pad throughout. No heaving."]},
    {id:"ohp",name:"Seated DB Shoulder Press",range:"3Ã—8â€“10",unit:"kg",tips:["Sit upright with back support. Don't arch aggressively.","Start with DBs at ear height, palms facing forward.","Press straight up â€” DBs can touch lightly at top.","Don't lock out and rest â€” keep tension on the delts.","If shoulders feel cooked from yoga, drop weight 10â€“15% guilt-free."]},
    {id:"cable_lat",name:"Cable Lateral Raise",range:"4Ã—12â€“15",unit:"kg",tips:["Cable pulled across the body gives better tension at the bottom.","Lead with your elbow, not your hand â€” think 'pour a jug'.","Raise to shoulder height only. Higher = traps, not delts.","Use a slow 3-sec lower â€” that's where the growth is.","Lighter weight done properly beats heavy and sloppy every time."]},
    {id:"face_pull",name:"Face Pull",range:"3Ã—15",unit:"kg",tips:["Set cable at upper-chest to face height with rope attachment.","Pull toward your forehead, flaring elbows high and wide.","Think: 'show your armpits' at the end of each rep.","Slow and controlled â€” this is shoulder health work, not ego lifting.","Light weight, high reps. Never rush this one."]},
  ], core:["Dead Bug â€” 3Ã—8/side","Pallof Press â€” 3Ã—10/side"] },
  B:{ label:"Day B", subtitle:"Delts + Back Thickness", exercises:[
    {id:"flat_db",name:"Flat DB Press",range:"4Ã—6â€“8",unit:"kg",tips:["Lie flat, feet planted. DBs start at chest height.","Elbows at 45â€“60Â° from body â€” not flared like a chicken.","Press explosively up, control slowly down.","Slight arch in lower back is fine. Ribs up, not flattened.","Touch DBs lightly at top but don't clang and bounce."]},
    {id:"lat_pd",name:"Lat Pulldown",range:"4Ã—8â€“10",unit:"kg",tips:["Grip slightly wider than shoulder width. Lean back ~15Â°.","Pull bar to upper chest â€” not behind the neck.","Lead with elbows driving down and back.","Squeeze lats hard at bottom, then control the rise.","Avoid using momentum â€” if you're swinging, the weight's too heavy."]},
    {id:"sa_row",name:"Single Arm DB Row",range:"3Ã—8â€“10",unit:"kg",tips:["Brace one hand and same-side knee on a bench.","Back stays flat and parallel to the floor â€” no rotation.","Pull DB to your hip, not your armpit.","Think: elbow back and up, like starting a lawnmower.","Full stretch at the bottom â€” let the lat lengthen before pulling."]},
    {id:"rear_delt",name:"Rear Delt Fly",range:"4Ã—12â€“15",unit:"kg",tips:["Hinge forward to ~45Â° or lie face-down on incline bench.","Arms slightly bent, raise out to the sides like wings.","Lead with your elbows â€” not your hands.","Squeeze rear delts at top. These are small muscles â€” go light.","Slow and controlled. 2 sec up, 3 sec down."]},
    {id:"lat_drop",name:"Lateral Raise Drop Set",range:"3 rounds",unit:"kg",tips:["Start at a weight you can do 12 clean reps.","When form breaks, immediately drop 2â€“4kg and continue.","3 drops per round = one brutal but effective set.","Keep the 'pour a jug' elbow-lead technique throughout.","Rest 90 sec between rounds â€” these will burn."]},
    {id:"leg_press",name:"Leg Press",range:"2â€“3Ã—8â€“10",unit:"kg",tips:["Feet shoulder-width, mid-height on the platform.","Lower until knees reach ~90Â° â€” don't let lower back peel off.","Press through your heels, not your toes.","Don't lock out knees at the top â€” keep tension on quads.","Controlled descent always. Don't let the sled drop."]},
  ], core:["Hanging Knee Raises â€” 3Ã—8â€“12","Cable Crunch / Ab Wheel â€” 3Ã—10â€“12"] },
  C:{ label:"Day C", subtitle:"Lower Bias (optional)", exercises:[
    {id:"rdl",name:"Romanian Deadlift",range:"4Ã—6â€“8",unit:"kg",tips:["Stand hip-width, soft bend in knees â€” keep them fixed.","Push hips back (not down) as you lower the bar.","Bar stays close to your legs the whole way down.","Feel a deep hamstring stretch at the bottom â€” that's the goal.","Drive hips forward to stand. Squeeze glutes at top."]},
    {id:"bss",name:"Bulgarian Split Squat",range:"3Ã—8/side",unit:"kg",tips:["Rear foot elevated on bench, front foot far enough forward.","Lower straight down â€” don't let front knee cave inward.","Front shin stays relatively vertical for more glute work.","Hold DBs at sides or use goblet position for balance.","Go slow on the way down. These will humble you."]},
    {id:"hip_thrust",name:"Hip Thrust",range:"3Ã—8â€“10",unit:"kg",tips:["Upper back on bench edge, bar or DB across hip crease.","Feet shoulder-width, toes slightly out.","Drive through heels â€” squeeze glutes HARD at the top.","Full hip extension at top. Don't just go halfway.","Control the descent. Don't let hips crash down."]},
    {id:"leg_curl",name:"Leg Curl",range:"3Ã—10â€“12",unit:"kg",tips:["Lie face down, keep hips pressed into the pad.","Curl heels to glutes â€” pause at top for 1 sec.","Lower slowly â€” 3 sec descent is where hamstrings grow.","Don't let your hips rise off the pad to cheat reps.","Last set can go close to failure â€” isolation is more forgiving."]},
    {id:"calf",name:"Calf Raises",range:"3Ã—12â€“15",unit:"kg",tips:["Full range: deep stretch at bottom, full rise at top.","Pause 1 sec at top, 2 sec at bottom for best results.","Single-leg version makes this much harder â€” worth trying.","Calves are stubborn â€” squeeze hard and go slow.","Weighted or bodyweight on a step both work well."]},
    {id:"farmer",name:"Farmer Carries",range:"3 rounds",unit:"kg",tips:["Pick a challenging but manageable weight in each hand.","Walk tall â€” chest up, shoulders packed down and back.","Short, controlled steps. Don't waddle side to side.","Grip is the limiter â€” that's the point. Let it burn.","~30m per round is a good target. Rest 60 sec between."]},
  ], core:[] },
};

const BENCHMARKS = {
  pullups:{label:"Pull-Ups",start:3,target:9,unit:"reps"},
  incline_db:{label:"Incline DB Press",start:22,target:40,unit:"kg"},
  ohp:{label:"OHP (per side)",start:12.5,target:20,unit:"kg"},
};

const MEALS = [
  {id:"morning",emoji:"ğŸŒ…",label:"Morning",desc:"Greek yogurt + fruit + nuts"},
  {id:"lunch",emoji:"ğŸ¥—",label:"Lunch",desc:"Veg-heavy + tofu / chicken / eggs"},
  {id:"postworkout",emoji:"ğŸ’ª",label:"Post-Workout",desc:"WPI shake + banana"},
  {id:"dinner",emoji:"ğŸ½ï¸",label:"Dinner",desc:"Carb + protein + veg"},
  {id:"bedtime",emoji:"ğŸŒ™",label:"Before Bed",desc:"Cottage cheese or yogurt (optional)"},
];

const NONNEG = [
  {id:"protein",emoji:"ğŸ¥©",label:"Protein",target:"130g today",colour:"#ef4444"},
  {id:"creatine",emoji:"âš¡",label:"Creatine",target:"5g daily",colour:"#8b5cf6"},
  {id:"water",emoji:"ğŸ’§",label:"Water",target:"2.5â€“3L today",colour:"#0eb8a0"},
];

const MOTTOS = ["Start before you feel ready.","Today counts. Begin.","One set is enough to start.","Show up. That's the win.","Begin messy. Improve later.","Five minutes. That's all you need.","Start small. Stay consistent.","Action creates motivation.","Put your shoes on. Go.","The first rep changes everything.","You don't need perfect conditions.","Just walk into the gym.","Start tired. Finish proud.","Today is a good day to begin.","One workout ahead of regret.","Don't think. Do the warm-up.","Start now. Adjust later.","Momentum loves starters.","Begin with one clean rep.","The door is the hardest part.","Show up imperfect.","Your future self votes today.","Build the habit. Not the mood.","Start light. Stay steady.","A short session still counts.","Start where you are.","Action over analysis.","The plan works when you begin.","Today's effort compounds.","Just press record on the habit.","First rep. No drama.","Don't wait for motivation. Create it.","Ten minutes beats zero.","Start quietly.","Begin with breath and movement.","One decision. That's all.","Turn up for yourself today.","Make today a training day.","Start before doubt speaks.","Small action. Big trajectory.","Move your body. Clear your mind.","The warm-up is the gateway.","Start with what you can do.","Done is better than delayed.","You only need to begin.","Lace up. That's step one.","Start now. Thank yourself later.","Begin again if you must.","Today is for showing up."];

const DEFAULT_HISTORY = {
  incline_db:[{w:22,r:6},{w:22,r:7},{w:22,r:8},{w:24,r:6}],
  pullups:[{w:0,r:3},{w:0,r:4},{w:0,r:4},{w:0,r:5}],
  cs_row:[{w:18,r:8},{w:18,r:9}], ohp:[{w:12.5,r:8},{w:12.5,r:9},{w:12.5,r:10}],
  cable_lat:[{w:8,r:12},{w:8,r:14}], face_pull:[{w:12,r:15}],
  flat_db:[{w:25,r:7},{w:25,r:8}], lat_pd:[{w:40,r:8},{w:40,r:10},{w:45,r:8}],
  sa_row:[{w:20,r:9}], rear_delt:[{w:8,r:12}], lat_drop:[{w:8,r:12}],
  leg_press:[{w:60,r:8},{w:60,r:10}], rdl:[{w:40,r:6},{w:40,r:8}],
  bss:[{w:16,r:8}], hip_thrust:[{w:40,r:8}], leg_curl:[{w:25,r:10}],
  calf:[{w:30,r:12}], farmer:[{w:20,r:0}],
};

// â”€â”€ STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SK = {
  history:"wt_history", week:"wt_week", shoulder:"wt_shoulder",
  bw:"wt_bw", completed:"wt_completed",
  nutDate:"wt_nut_date", nutChecks:"wt_nut_checks", mealChecks:"wt_meal_checks",
  lastAutoWeek:"wt_last_auto_week",
};

function lsGet(key,fallback){ try{const v=localStorage.getItem(key);return v?JSON.parse(v):fallback;}catch{return fallback;} }
function lsSet(key,val){ try{localStorage.setItem(key,JSON.stringify(val));}catch{} }
function todayStr(){ return new Date().toISOString().slice(0,10); }

// â”€â”€ BOOT STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const today = todayStr();
const now   = new Date();
const savedNutDate = lsGet(SK.nutDate, today);
const nutFresh = savedNutDate === today;

// Auto-advance week every Sunday after 12:01am
const isSunday      = now.getDay() === 0;
const pastMidnight  = now.getHours() === 0 && now.getMinutes() >= 1;
const lastAutoWeek  = lsGet(SK.lastAutoWeek, null);
let savedWeek       = lsGet(SK.week, 1);
let savedCompleted  = lsGet(SK.completed, {A:false,B:false,C:false});

if(isSunday && pastMidnight && lastAutoWeek !== today && savedWeek < 7){
  savedWeek++;
  savedCompleted = {A:false,B:false,C:false};
  lsSet(SK.week, savedWeek);
  lsSet(SK.completed, savedCompleted);
  lsSet(SK.lastAutoWeek, today);
}

const state = {
  view:"home", activeDay:null, logSheet:null, tipsSheet:null,
  history: lsGet(SK.history, DEFAULT_HISTORY),
  sessionLogs:{},
  shoulderFlag: lsGet(SK.shoulder, false),
  weekNum: savedWeek,
  bodyweight: lsGet(SK.bw, [70.8,71.0,71.1]),
  bwInput:"",
  chartEx:null,
  completed: savedCompleted,
  nutChecks: nutFresh ? lsGet(SK.nutChecks,{protein:false,creatine:false,water:false}) : {protein:false,creatine:false,water:false},
  mealChecks: nutFresh ? lsGet(SK.mealChecks,{}) : {},
  motto: MOTTOS[Math.floor(Math.random()*MOTTOS.length)],
};
if(!nutFresh){ lsSet(SK.nutDate,today); lsSet(SK.nutChecks,state.nutChecks); lsSet(SK.mealChecks,state.mealChecks); }

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setState(patch){ Object.assign(state,patch); render(); }
function persist(key,val){ lsSet(key,val); }
function getLastLog(id){ const h=state.history[id]; return h&&h.length?h[h.length-1]:{w:0,r:0}; }
function isDeload(){ return state.weekNum===7; }

function getPreFill(id){
  const last=getLastLog(id);
  return isDeload()?{w:Math.round(last.w*0.8*2)/2,r:last.r}:last;
}

function getGreeting(){
  const h=now.getHours(), m=now.getMinutes(), t=h+m/60;
  if(t>=8&&t<11.5) return "Good morning ğŸ‘‹ğŸ¼";
  if(t>=11.5&&t<13) return "Lunch ğŸ½ï¸";
  if(t>=13&&t<17)  return "Good afternoon ğŸ™ŒğŸ¼";
  if(t>=17&&t<24)  return "Good evening ğŸ™‚â€â†•ï¸";
  if(t>=0&&t<5)    return "Hey nightowl ğŸ¦‰";
  return "Hey earlybird ğŸ¦†";
}

function isEvening(){ return now.getHours()>=17; }

function weightStalled(){
  const bw=state.bodyweight;
  if(bw.length<4) return false;
  const r=bw.slice(-4);
  return r[r.length-1]-r[0]<0.1;
}

function nutDoneCount(){ return Object.values(state.nutChecks).filter(Boolean).length; }
function mealDoneCount(){ return Object.values(state.mealChecks).filter(Boolean).length; }

function weekCardText(){
  const w=state.weekNum;
  const lightWeeks=[1,2,3];
  const isLight=lightWeeks.includes(w)||w===7;
  const txt    = w===7?"#78350f": isLight?T.dark:"#fff";
  const muted  = w===7?"rgba(120,53,15,0.55)": isLight?"rgba(10,60,40,0.55)":"rgba(255,255,255,0.7)";
  const dotFull   = w===7?"rgba(120,53,15,0.7)": isLight?"rgba(10,60,40,0.6)":"rgba(255,255,255,0.85)";
  const dotActive = w===7?"rgba(120,53,15,0.4)": isLight?"rgba(10,60,40,0.35)":"rgba(255,255,255,0.5)";
  const dotEmpty  = w===7?"rgba(120,53,15,0.18)":isLight?"rgba(10,60,40,0.15)":"rgba(255,255,255,0.22)";
  const resetBg   = w===7?"rgba(120,53,15,0.1)": isLight?"rgba(10,60,40,0.1)":"rgba(255,255,255,0.22)";
  const resetBdr  = w===7?"rgba(120,53,15,0.25)":isLight?"rgba(10,60,40,0.25)":"rgba(255,255,255,0.4)";
  return {txt,muted,dotFull,dotActive,dotEmpty,resetBg,resetBdr};
}

// â”€â”€ SVG SPARKLINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sparklineSVG(data){
  if(!data||data.length<2) return '<span style="font-size:11px;color:#999">Not enough data</span>';
  const vals=data.map(d=>d.r||d.w);
  const mn=Math.min(...vals),mx=Math.max(...vals),rng=mx-mn||1;
  const W=80,H=28;
  const pts=vals.map((v,i)=>`${(i/(vals.length-1))*W},${H-((v-mn)/rng)*(H-4)-2}`).join(" ");
  const up=vals[vals.length-1]>=vals[0];
  const col=up?T.mid:"#ef4444";
  const circles=vals.map((v,i)=>`<circle cx="${(i/(vals.length-1))*W}" cy="${H-((v-mn)/rng)*(H-4)-2}" r="2.5" fill="${col}"/>`).join("");
  return `<svg width="${W}" height="${H}"><polyline points="${pts}" fill="none" stroke="${col}" stroke-width="2" stroke-linejoin="round"/>${circles}</svg>`;
}

function pbarHTML(value,max,gradient=false){
  const pct=Math.min((value/max)*100,100);
  return `<div class="pbar-wrap"><div class="pbar-fill" style="width:${pct}%;background:${gradient?T.grad:T.teal}"></div></div>`;
}

// â”€â”€ VIEWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderWeekCard(){
  const w=state.weekNum;
  const grad=WEEK_GRADS[w]||WEEK_GRADS[1];
  const c=weekCardText();
  const glow=w===7?"0 2px 12px rgba(251,191,36,0.2)":T.glow;
  const icon=w===7?"ğŸŒ¿":w<=3?"ğŸ“ˆ":"ğŸ‹ï¸";
  const label=w===7?"Deload":w<=3?"Add Reps":"Add Weight";
  const hint=w===7?"Rest is productive. You earn Week 1 by recovering well.":w<=3?"Focus: add reps within target range each session":"Focus: increase weight once you hit the top of your range";
  const dots=[1,2,3,4,5,6,7].map(i=>`<div onclick="setWeek(${i})" style="flex:1;height:8px;border-radius:99px;cursor:pointer;background:${i<w?c.dotFull:i===w?c.dotActive:c.dotEmpty};transition:background 0.2s"></div>`).join("");
  return `<div style="background:${grad};border-radius:22px;padding:20px 20px 18px;margin-bottom:20px;color:${c.txt};box-shadow:${glow};position:relative;overflow:hidden">
    <div style="position:absolute;top:-30px;right:-30px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,0.1);pointer-events:none"></div>
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px">
      <div>
        <div style="font-size:11px;color:${c.muted};text-transform:uppercase;letter-spacing:0.8px">Training Wave</div>
        <div style="font-size:22px;font-weight:800;margin-top:2px">Week ${w} / 7</div>
        <div style="display:flex;align-items:center;gap:5px;margin-top:5px">
          <span style="font-size:13px">${icon}</span>
          <span style="font-size:13px;font-weight:600;opacity:0.9">${label}</span>
        </div>
      </div>
      <button onclick="setWeek(1)" style="background:${c.resetBg};backdrop-filter:blur(8px);border:1px solid ${c.resetBdr};border-radius:99px;padding:6px 12px;font-size:11px;font-weight:700;color:${c.txt};cursor:pointer;margin-top:4px;font-family:inherit">â†º Reset</button>
    </div>
    <div style="display:flex;gap:6px;margin-top:12px">${dots}</div>
    <div style="font-size:11px;color:${c.muted};margin-top:10px">${hint}</div>
  </div>`;
}

function renderHome(){
  const nd=nutDoneCount(), md=mealDoneCount();
  const nutDots=NONNEG.map(n=>`<div style="width:10px;height:10px;border-radius:50%;background:${state.nutChecks[n.id]?n.colour:"#ddd"};box-shadow:${state.nutChecks[n.id]?`0 0 6px ${n.colour}66`:""}"></div>`).join("");
  const sf=state.shoulderFlag;

  // Day cards OR deload content
  let sessionContent="";
  if(isDeload()){
    const deloadDays=[
      {label:"Day A",subtitle:"Upper Chest + Lats",exercises:[{name:"Incline DB Press",adj:"80% weight Â· 2 sets"},{name:"Pull-Ups",adj:"80% effort Â· 2 sets â€” stop short of failure"},{name:"Chest Supported Row",adj:"80% weight Â· 2 sets"},{name:"Seated DB Shoulder Press",adj:"80% weight Â· 2 sets"},{name:"Cable Lateral Raise",adj:"Light Â· 2 sets â€” focus on feel"},{name:"Face Pull",adj:"Light Â· 2 sets â€” shoulder health priority"}],core:"Keep Dead Bug + Pallof Press â€” full sets, clean reps"},
      {label:"Day B",subtitle:"Delts + Back Thickness",exercises:[{name:"Flat DB Press",adj:"80% weight Â· 2 sets"},{name:"Lat Pulldown",adj:"80% weight Â· 2 sets"},{name:"Single Arm DB Row",adj:"80% weight Â· 2 sets"},{name:"Rear Delt Fly",adj:"Light Â· 2 sets"},{name:"Lateral Raise",adj:"Light only Â· 2 sets â€” no drop set"},{name:"Leg Press",adj:"80% weight Â· 2 sets"}],core:"Keep Hanging Knee Raises + Ab Wheel â€” full sets"},
      {label:"Day C",subtitle:"Lower Bias (optional â€” skip if fatigued)",optional:true,exercises:[{name:"Romanian Deadlift",adj:"80% weight Â· 2 sets"},{name:"Bulgarian Split Squat",adj:"80% weight Â· 2 sets"},{name:"Hip Thrust",adj:"80% weight Â· 2 sets"},{name:"Leg Curl",adj:"80% weight Â· 2 sets"},{name:"Calf Raises",adj:"Bodyweight or light Â· 2 sets"},{name:"Farmer Carries",adj:"Skip this week â€” grip/CNS recovery"}],core:null},
    ];
    const whyCard=`<div style="background:linear-gradient(135deg,rgba(107,229,61,0.12),rgba(14,184,160,0.12));border:1.5px solid rgba(14,184,160,0.2);border-radius:18px;padding:16px 18px;margin-bottom:14px">
      <div style="font-size:15px;font-weight:800;color:${T.dark};margin-bottom:6px">Why this week matters</div>
      <div style="font-size:13px;color:#555;line-height:1.6">Your muscles grow during recovery, not during training. This week lets your joints, tendons, and nervous system catch up â€” so you come back to Week 1 stronger, not just fresher. Don't skip it.</div>
    </div>`;
    const dayCards=deloadDays.map(day=>{
      const exRows=day.exercises.map((ex,i)=>`<div style="display:flex;justify-content:space-between;align-items:flex-start;padding-bottom:7px;margin-bottom:7px;border-bottom:${i<day.exercises.length-1?"1px solid #f4f4f4":"none"}">
        <div style="font-size:13px;font-weight:600;color:${T.dark};flex:1">${ex.name}</div>
        <div style="font-size:12px;color:${T.accent};font-weight:500;text-align:right;margin-left:8px">${ex.adj}</div>
      </div>`).join("");
      const coreRow=day.core?`<div style="margin-top:10px;background:linear-gradient(135deg,rgba(107,229,61,0.12),rgba(14,184,160,0.12));border-radius:10px;padding:8px 12px;font-size:12px;color:${T.accent};border:1px solid rgba(14,184,160,0.15)">ğŸ§˜ ${day.core}</div>`:"";
      return `<div style="background:#fff;border:1.5px solid #eee;border-radius:18px;padding:16px 18px;margin-bottom:12px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
          <span style="font-size:15px;font-weight:800;color:${T.dark}">${day.label}</span>
          ${day.optional?'<span class="tag optional-tag">OPTIONAL</span>':""}
          <span class="tag deload-tag">ğŸ”„ DELOAD</span>
        </div>
        <div style="font-size:12px;color:#888;margin-bottom:10px">${day.subtitle}</div>
        ${exRows}${coreRow}
      </div>`;
    }).join("");
    const resetCard=`<div style="background:#f8f8f8;border-radius:16px;padding:14px 18px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-size:13px;font-weight:700;color:${T.dark}">Ready to start Wave 2?</div>
        <div style="font-size:12px;color:#888;margin-top:2px">Tap Reset to begin Week 1 fresh.</div>
      </div>
      <button onclick="setWeek(1)" style="background:${T.grad};color:#fff;border:none;border-radius:12px;padding:10px 18px;font-size:13px;font-weight:700;cursor:pointer;box-shadow:${T.glowSm};white-space:nowrap;font-family:inherit">â†º Reset</button>
    </div>`;
    sessionContent=`<div class="section-label">Deload Week ğŸ”„</div>${whyCard}${dayCards}${resetCard}`;
  } else {
    const cards=Object.entries(DAYS).map(([key,day])=>{
      const done=state.completed[key];
      const chips=day.exercises.slice(0,3).map(ex=>{
        const pre=getPreFill(ex.id);
        return `<div style="background:linear-gradient(135deg,rgba(107,229,61,0.12),rgba(14,184,160,0.12));border-radius:8px;padding:4px 10px;font-size:12px;color:${T.accent};border:1px solid rgba(14,184,160,0.15)">${ex.name.split(" ").slice(0,2).join(" ")} Â· ${ex.unit==="BW"?`BWÃ—${pre.r}`:`${pre.w}kg`}</div>`;
      }).join("")+(day.exercises.length>3?`<div style="background:#f4f4f4;border-radius:8px;padding:4px 10px;font-size:12px;color:#aaa">+${day.exercises.length-3} more</div>`:"");
      return `<div onclick="openDay('${key}')" style="background:${done?"#f8f8f8":"#fff"};border:1.5px solid ${done?"#e5e5e5":"#e0f7f4"};border-radius:18px;padding:16px 18px;margin-bottom:12px;cursor:pointer;box-shadow:${done?"none":"0 2px 12px rgba(14,184,160,0.07)"}">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px">
              <span style="font-size:16px;font-weight:800;color:${T.dark}">${day.label}</span>
              ${key==="C"?'<span class="tag optional-tag">OPTIONAL</span>':""}
              ${done?'<span style="font-size:12px">âœ…</span>':""}
            </div>
            <div style="font-size:13px;color:#888">${day.subtitle}</div>
          </div>
          <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,rgba(107,229,61,0.12),rgba(14,184,160,0.12));display:flex;align-items:center;justify-content:center;font-size:16px;color:${T.teal};border:1.5px solid rgba(14,184,160,0.2)">â€º</div>
        </div>
        <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:6px">${chips}</div>
      </div>`;
    }).join("");
    sessionContent=`<div class="section-label">This Week's Sessions</div>${cards}`;
  }

  const bwLast=state.bodyweight[state.bodyweight.length-1];
  return `<div class="page">
    <div style="padding-top:56px;margin-bottom:24px">
      <div style="font-size:26px;font-weight:800;letter-spacing:-0.5px;color:${T.dark}">${getGreeting()}</div>
      <div style="font-size:14px;color:#888;margin-top:4px">${state.motto}</div>
    </div>
    ${renderWeekCard()}
    <div style="border-radius:16px;padding:14px 16px;margin-bottom:14px;background:${sf?"#fff3cd":"#f8f8f8"};border:1px solid ${sf?"#f59e0b":"#eee"};display:flex;align-items:center;justify-content:space-between">
      <div>
        <div style="font-size:13px;font-weight:700;color:${sf?"#92400e":T.dark}">${sf?"âš ï¸ Shoulder Fatigue Flagged":"ğŸ‹ï¸ Shoulders feeling good"}</div>
        <div style="font-size:12px;color:#888;margin-top:2px">${sf?"Reduce pressing sets by 1 this week":"Tap to flag fatigue"}</div>
      </div>
      <div id="shoulder-toggle" style="width:44px;height:26px;border-radius:99px;cursor:pointer;background:${sf?"#f59e0b":T.teal};position:relative;transition:background 0.2s;box-shadow:${sf?"none":T.glowSm}">
        <div style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:3px;left:${sf?21:3}px;transition:left 0.2s;box-shadow:0 1px 3px rgba(0,0,0,0.2)"></div>
      </div>
    </div>
    <div onclick="setView('nutrition')" style="border-radius:16px;padding:14px 16px;margin-bottom:14px;background:${nutDoneCount()===3?"linear-gradient(135deg,rgba(107,229,61,0.12),rgba(14,184,160,0.12))":"#f8f8f8"};border:1.5px solid ${nutDoneCount()===3?"rgba(14,184,160,0.3)":"#eee"};cursor:pointer;display:flex;align-items:center;justify-content:space-between">
      <div>
        <div style="font-size:13px;font-weight:700;color:${T.dark}">ğŸ¥— Today's Nutrition</div>
        <div style="font-size:12px;color:#888;margin-top:2px">${nd}/3 non-negotiables Â· ${md}/5 meals</div>
      </div>
      <div style="display:flex;gap:6px;align-items:center">${nutDots}</div>
    </div>
    ${sessionContent}
    <div style="background:#f8f8f8;border-radius:18px;padding:16px 18px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div>
          <div style="font-size:14px;font-weight:700;color:${T.dark}">Bodyweight</div>
          <div style="font-size:12px;color:#888">Target: +0.1â€“0.2kg/month</div>
        </div>
        <div style="font-size:22px;font-weight:800;color:${T.dark}">${bwLast}kg</div>
      </div>
      ${sparklineSVG(state.bodyweight.map(w=>({w,r:w})))}
      <div style="display:flex;gap:8px;margin-top:12px">
        <input id="bw-input" type="number" placeholder="Log today's weight"
          style="flex:1;border:1.5px solid #e5e5e5;border-radius:10px;padding:10px 12px;font-size:14px;outline:none;font-family:inherit"
          onfocus="this.style.borderColor='${T.teal}'" onblur="this.style.borderColor='#e5e5e5'">
        <button onclick="logBW()" style="background:${T.grad};color:#fff;border:none;border-radius:10px;padding:10px 16px;font-size:14px;font-weight:700;cursor:pointer;box-shadow:${T.glowSm};font-family:inherit">Log</button>
      </div>
    </div>
  </div>`;
}

function renderSession(){
  const key=state.activeDay; if(!key) return "";
  const day=DAYS[key];
  const loggedCount=day.exercises.filter(ex=>state.sessionLogs[ex.id]).length;
  const progress=loggedCount/day.exercises.length;
  const sfWarn=state.shoulderFlag&&(key==="A"||key==="B")?`<div style="background:#fff3cd;border-radius:14px;padding:12px 16px;margin-bottom:14px;font-size:13px;color:#92400e">âš ï¸ Shoulder fatigue â€” reduce pressing sets by 1 today</div>`:"";
  const exRows=day.exercises.map((ex,i)=>{
    const entry=state.sessionLogs[ex.id];
    const pre=getPreFill(ex.id), last=getLastLog(ex.id), isBW=ex.unit==="BW";
    const improved=entry&&(Number(entry.r)>last.r||Number(entry.w)>last.w);
    const statusLine=entry
      ?`<div style="font-size:13px;color:${T.teal};font-weight:700;margin-top:4px">${isBW?`BW Ã— ${entry.r} reps`:`${entry.w}kg Ã— ${entry.r} reps`}${improved?" ğŸ”¥":""}</div>`
      :`<div style="font-size:12px;color:#bbb;margin-top:4px">Pre-filled: ${isBW?`BWÃ—${pre.r}`:`${pre.w}kgÃ—${pre.r}`}${isDeload()?" (80%)":""}</div>`;
    const exData=encodeURIComponent(JSON.stringify(ex));
    return `<div style="background:${entry?"linear-gradient(135deg,rgba(107,229,61,0.12),rgba(14,184,160,0.12))":"#fff"};border:1.5px solid ${entry?"rgba(14,184,160,0.35)":"#eee"};border-radius:16px;padding:14px 16px;margin-bottom:10px;box-shadow:${entry?T.glowSm:""}">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="flex:1" onclick="openLog('${key}',${i})">>
          <div style="font-size:15px;font-weight:700;color:${T.dark}">${ex.name}</div>
          <div style="font-size:12px;color:#888;margin-top:2px">${ex.range}</div>
          ${statusLine}
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <button onclick="openTips('${ex.id}')" style="background:linear-gradient(135deg,rgba(107,229,61,0.12),rgba(14,184,160,0.12));border:1px solid rgba(14,184,160,0.2);border-radius:10px;width:34px;height:34px;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center">ğŸ’¡</button>
          <div onclick="toggleExercise('${key}',${i})" style="width:32px;height:32px;border-radius:50%;background:${entry?T.grad:"#f0f0f0"};display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;color:${entry?"#fff":"#ccc"};box-shadow:${entry?T.glowSm:""};font-weight:800">${entry?"âœ“":"+"}</div>
        </div>
      </div>
    </div>`;
  }).join("");
  const coreSection=day.core.length?`<div style="background:#f8f8f8;border-radius:16px;padding:14px 16px;margin-bottom:16px"><div class="section-label" style="margin-bottom:8px">Core</div>${day.core.map(c=>`<div style="font-size:13px;color:#555;margin-bottom:4px">â€¢ ${c}</div>`).join("")}</div>`:"";
  return `<div class="page">
    <div style="padding-top:56px;margin-bottom:20px">
      <button onclick="setView('home')" style="background:none;border:none;font-size:14px;color:${T.accent};cursor:pointer;padding:0;margin-bottom:12px;font-weight:600;font-family:inherit">â† Back</button>
      <div style="display:flex;align-items:center;gap:10px">
        <div style="font-size:24px;font-weight:800;color:${T.dark}">${day.label}</div>
        ${isDeload()?'<span class="tag deload-tag" style="font-size:11px;padding:3px 9px">ğŸ”„ Deload</span>':""}
      </div>
      <div style="font-size:14px;color:#888">${day.subtitle}</div>
      <div style="margin-top:12px">${pbarHTML(loggedCount,day.exercises.length)}</div>
      <div style="font-size:12px;color:${T.accent};margin-top:6px;font-weight:600">${loggedCount} / ${day.exercises.length} logged</div>
    </div>
    ${sfWarn}${exRows}${coreSection}
    <button onclick="finishSession('${key}')" style="width:100%;background:${T.grad};color:#fff;border:none;border-radius:16px;padding:18px;font-size:16px;font-weight:800;cursor:pointer;box-shadow:${T.glow};font-family:inherit">Finish Session âœ“</button>
  </div>`;
}

function renderProgress(){
  const allEx=Object.values(DAYS).flatMap(d=>d.exercises);
  const benchCards=Object.entries(BENCHMARKS).map(([id,b])=>{
    const h=state.history[id]||[];
    const current=h.length?(b.unit==="reps"?h[h.length-1].r:h[h.length-1].w):b.start;
    const pct=Math.round(Math.max(0,((current-b.start)/(b.target-b.start))*100));
    return `<div style="background:#f8f8f8;border-radius:16px;padding:14px 16px;margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;margin-bottom:8px">
        <div style="font-size:14px;font-weight:700;color:${T.dark}">${b.label}</div>
        <div style="font-size:13px;font-weight:800;color:${T.teal}">${current} <span style="color:#aaa;font-weight:400">/ ${b.target} ${b.unit}</span></div>
      </div>
      ${pbarHTML(current-b.start,b.target-b.start,true)}
      <div style="font-size:11px;color:${T.accent};margin-top:6px;font-weight:600">${pct}% to goal</div>
    </div>`;
  }).join("");
  const exCards=allEx.map(ex=>{
    const h=state.history[ex.id]; if(!h||h.length<2) return "";
    const recent=h.slice(-7);
    const latest=recent[recent.length-1],first=recent[0];
    const up=ex.unit==="BW"?latest.r>first.r:latest.w>first.w||latest.r>first.r;
    const expanded=state.chartEx===ex.id;
    const chips=expanded?`<div style="margin-top:12px;display:flex;gap:6px;flex-wrap:wrap">${recent.map((e,i)=>`<div style="background:linear-gradient(135deg,rgba(107,229,61,0.12),rgba(14,184,160,0.12));border-radius:8px;padding:4px 10px;font-size:12px;color:${T.accent};border:1px solid rgba(14,184,160,0.15)">#${h.length-recent.length+i+1}: ${ex.unit==="BW"?`BWÃ—${e.r}`:`${e.w}kgÃ—${e.r}`}</div>`).join("")}</div>`:"";
    return `<div onclick="toggleChart('${ex.id}')" style="background:#fff;border:1.5px solid #eee;border-radius:16px;padding:14px 16px;margin-bottom:10px;cursor:pointer">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-size:14px;font-weight:700;color:${T.dark}">${ex.name}</div>
          <div style="font-size:12px;color:${up?T.teal:"#888"};margin-top:2px;font-weight:${up?700:400}">${ex.unit==="BW"?`BWÃ—${latest.r} reps`:`${latest.w}kg Ã— ${latest.r} reps`} ${up?"â†‘":""}</div>
        </div>
        ${sparklineSVG(recent)}
      </div>
      ${chips}
    </div>`;
  }).join("");
  return `<div class="page">
    <div style="padding-top:56px;margin-bottom:24px">
      <div style="font-size:26px;font-weight:800;color:${T.dark}">Progress ğŸ“ˆ</div>
      <div style="font-size:14px;color:#888">Top set history per exercise</div>
    </div>
    <div class="section-label">12-Month Benchmarks</div>
    ${benchCards}
    <div class="section-label" style="margin-top:20px">Exercise History</div>
    ${exCards}
  </div>`;
}

function renderNutrition(){
  const nd=nutDoneCount(), allDone=nd===3;
  const eveningBanner=isEvening()&&!allDone?`<div style="background:#fff3cd;border:1px solid #f59e0b;border-radius:16px;padding:14px 16px;margin-bottom:16px;display:flex;gap:10px;align-items:flex-start"><span style="font-size:20px">ğŸŒ™</span><div><div style="font-size:13px;font-weight:700;color:#92400e">Evening reminder</div><div style="font-size:12px;color:#92400e;margin-top:2px">You still have ${3-nd} non-negotiable${3-nd>1?"s":""} to tick off before bed.</div></div></div>`:"";
  const stallBanner=weightStalled()?`<div style="background:#fef2f2;border:1px solid #fca5a5;border-radius:16px;padding:14px 16px;margin-bottom:16px;display:flex;gap:10px;align-items:flex-start"><span style="font-size:20px">âš ï¸</span><div><div style="font-size:13px;font-weight:700;color:#991b1b">Weight stall detected</div><div style="font-size:12px;color:#991b1b;margin-top:2px">No meaningful gain across your last 4 weigh-ins. Per your plan: add ~150 calories daily.</div></div></div>`:"";
  const nutCards=NONNEG.map(n=>{
    const done=state.nutChecks[n.id];
    return `<div onclick="toggleNut('${n.id}')" style="background:${done?"linear-gradient(135deg,rgba(107,229,61,0.12),rgba(14,184,160,0.12))":"#fff"};border:1.5px solid ${done?"rgba(14,184,160,0.3)":"#eee"};border-radius:16px;padding:16px 18px;margin-bottom:10px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;box-shadow:${done?T.glowSm:""}">
      <div style="display:flex;align-items:center;gap:14px">
        <div style="width:44px;height:44px;border-radius:14px;background:${done?"linear-gradient(135deg,rgba(107,229,61,0.12),rgba(14,184,160,0.12))":"#f8f8f8"};display:flex;align-items:center;justify-content:center;font-size:22px;border:2px solid ${done?T.teal:"#eee"}">${n.emoji}</div>
        <div>
          <div style="font-size:15px;font-weight:700;color:${T.dark}">${n.label}</div>
          <div style="font-size:13px;color:#888;margin-top:2px">${n.target}</div>
        </div>
      </div>
      <div style="width:28px;height:28px;border-radius:50%;background:${done?T.grad:"#f0f0f0"};display:flex;align-items:center;justify-content:center;font-size:14px;color:#fff;box-shadow:${done?T.glowSm:""}">${done?"âœ“":""}</div>
    </div>`;
  }).join("");
  const celebLine=allDone?`<div style="background:linear-gradient(135deg,rgba(107,229,61,0.12),rgba(14,184,160,0.12));border:1px solid rgba(14,184,160,0.25);border-radius:14px;padding:12px 16px;margin-bottom:20px;text-align:center;font-size:14px;font-weight:700;color:${T.teal}">ğŸ‰ All non-negotiables done today!</div>`:"";
  const mealCards=MEALS.map(meal=>{
    const done=state.mealChecks[meal.id];
    return `<div onclick="toggleMeal('${meal.id}')" style="background:${done?"#f8f8f8":"#fff"};border:1.5px solid #eee;border-radius:14px;padding:13px 16px;margin-bottom:8px;cursor:pointer;display:flex;align-items:center;gap:14px">
      <span style="font-size:22px;opacity:${done?0.5:1}">${meal.emoji}</span>
      <div style="flex:1">
        <div style="font-size:14px;font-weight:700;text-decoration:${done?"line-through":"none"};color:${done?"#aaa":T.dark}">${meal.label}</div>
        <div style="font-size:12px;color:#aaa;margin-top:2px">${meal.desc}</div>
      </div>
      <div style="width:26px;height:26px;border-radius:50%;background:${done?T.grad:"#f0f0f0"};display:flex;align-items:center;justify-content:center;font-size:13px;color:#fff;box-shadow:${done?T.glowSm:""}">${done?"âœ“":""}</div>
    </div>`;
  }).join("");
  const guideRows=[{label:"Target gain",value:"0.1â€“0.2 kg/month",color:T.teal},{label:"No gain after 4 weeks?",value:"Add ~150 cal/day",color:"#f59e0b"},{label:"Gaining >0.3 kg/month?",value:"Reduce slightly",color:"#ef4444"}].map((row,i)=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:${i<2?"1px solid #eee":"none"}"><div style="font-size:13px;color:#555">${row.label}</div><div style="font-size:13px;font-weight:700;color:${row.color}">${row.value}</div></div>`).join("");
  return `<div class="page">
    <div style="padding-top:56px;margin-bottom:24px">
      <div style="font-size:26px;font-weight:800;color:${T.dark}">Nutrition ğŸ¥—</div>
      <div style="font-size:14px;color:#888">Today's non-negotiables</div>
    </div>
    ${eveningBanner}${stallBanner}
    <div class="section-label">Non-Negotiables</div>
    ${nutCards}${celebLine}
    <div class="section-label" style="margin-top:8px">Meal Timing</div>
    ${mealCards}
    <div style="background:#f8f8f8;border-radius:18px;padding:16px 18px;margin-top:8px">
      <div style="font-size:13px;font-weight:700;color:${T.dark};margin-bottom:10px">âš–ï¸ Weight Gain Guide</div>
      ${guideRows}
    </div>
  </div>`;
}

function renderLogSheet(){
  if(!state.logSheet) return "";
  const {dayKey,exIdx}=state.logSheet;
  const ex=DAYS[dayKey].exercises[exIdx];
  const log=state.sessionLogs[ex.id]||{w:0,r:0}, last=getLastLog(ex.id), isBW=ex.unit==="BW";
  const deloadNote=isDeload()?`<div style="background:#fff8e6;border:1px solid #f59e0b;border-radius:10px;padding:8px 12px;margin-top:10px;font-size:12px;color:#92400e">ğŸ”„ Deload â€” weight auto-set to 80%. Cut sets in half.</div>`:"";
  const weightRow=!isBW?`<div style="margin-top:18px;margin-bottom:20px">
    <div style="font-size:12px;color:${T.accent};font-weight:700;margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px">Weight (kg)</div>
    <div style="display:flex;align-items:center;gap:16px">
      <button onclick="adjLog('w',-1)" style="background:#f4f4f4;color:#333;border:none;border-radius:12px;padding:12px 20px;font-size:15px;font-weight:700;cursor:pointer;min-width:56px;font-family:inherit">âˆ’1</button>
      <div style="font-size:32px;font-weight:800;flex:1;text-align:center;color:${T.dark}">${log.w}</div>
      <button onclick="adjLog('w',1)" style="background:${T.grad};color:#fff;border:none;border-radius:12px;padding:12px 20px;font-size:15px;font-weight:700;cursor:pointer;min-width:56px;font-family:inherit">+1</button>
    </div>
  </div>`:"";
  const exData=encodeURIComponent(JSON.stringify(ex));
  return `<div class="sheet-overlay" onclick="if(event.target===this)closeLog()">
    <div class="sheet">
      <div class="sheet-handle"></div>
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px">
        <div>
          <div style="font-size:18px;font-weight:700;color:${T.dark}">${ex.name}</div>
          <div style="font-size:13px;color:#888;margin-top:2px">${ex.range} Â· Last: ${isBW?`BWÃ—${last.r}`:`${last.w}kgÃ—${last.r}`}${isDeload()?`<span style="color:#f59e0b;font-weight:700"> Â· ğŸ”„ 80%</span>`:""}</div>
        </div>
        <button onclick="closeLog();openTips('${ex.id}')" style="background:linear-gradient(135deg,rgba(107,229,61,0.12),rgba(14,184,160,0.12));border:1.5px solid rgba(14,184,160,0.25);border-radius:10px;padding:6px 12px;font-size:12px;font-weight:700;cursor:pointer;color:${T.accent};font-family:inherit">ğŸ’¡ Tips</button>
      </div>
      ${deloadNote}${weightRow}
      <div style="margin-bottom:28px">
        <div style="font-size:12px;color:${T.accent};font-weight:700;margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px">Top Set Reps</div>
        <div style="display:flex;align-items:center;gap:16px">
          <button onclick="adjLog('r',-1)" style="background:#f4f4f4;color:#333;border:none;border-radius:12px;padding:12px 20px;font-size:15px;font-weight:700;cursor:pointer;min-width:56px;font-family:inherit">âˆ’1</button>
          <div style="font-size:32px;font-weight:800;flex:1;text-align:center;color:${T.dark}">${log.r}</div>
          <button onclick="adjLog('r',1)" style="background:${T.grad};color:#fff;border:none;border-radius:12px;padding:12px 20px;font-size:15px;font-weight:700;cursor:pointer;min-width:56px;font-family:inherit">+1</button>
        </div>
      </div>
      <button onclick="saveLog()" style="width:100%;background:${T.grad};color:#fff;border:none;border-radius:14px;padding:16px;font-size:16px;font-weight:800;cursor:pointer;box-shadow:${T.glowSm};font-family:inherit">Log Top Set âœ“</button>
      <button onclick="closeLog()" style="width:100%;padding:12px;font-size:14px;color:#888;background:none;border:none;margin-top:8px;cursor:pointer;font-family:inherit">Cancel</button>
    </div>
  </div>`;
}

function renderTipsSheet(){
  if(!state.tipsSheet) return "";
  const ex=state.tipsSheet;
  const tips=ex.tips.map((tip,i)=>`<div style="display:flex;gap:12px;margin-bottom:14px;align-items:flex-start"><div class="tip-num">${i+1}</div><div style="font-size:14px;color:#333;line-height:1.5">${tip}</div></div>`).join("");
  return `<div class="sheet-overlay" onclick="if(event.target===this)closeTips()">
    <div class="sheet">
      <div class="sheet-handle"></div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:18px">
        <div style="width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,rgba(107,229,61,0.12),rgba(14,184,160,0.12));display:flex;align-items:center;justify-content:center;font-size:20px;border:1.5px solid rgba(14,184,160,0.2)">ğŸ’¡</div>
        <div><div style="font-size:17px;font-weight:800;color:${T.dark}">${ex.name}</div><div style="font-size:12px;color:#888">Form & technique tips</div></div>
      </div>
      ${tips}
      <button onclick="closeTips()" style="width:100%;background:${T.grad};color:#fff;border:none;border-radius:14px;padding:16px;font-size:15px;font-weight:800;cursor:pointer;box-shadow:${T.glowSm};margin-top:8px;font-family:inherit">Got it âœ“</button>
    </div>
  </div>`;
}

function renderTabBar(){
  const nd=nutDoneCount();
  const tabs=[{key:"home",icon:"ğŸ ",label:"Home"},{key:"nutrition",icon:"ğŸ¥—",label:"Nutrition",badge:nd<3&&isEvening()},{key:"progress",icon:"ğŸ“ˆ",label:"Progress"}];
  return `<div class="tab-bar">${tabs.map(t=>`<button class="tab-btn" onclick="setView('${t.key}')">
    <span style="font-size:20px">${t.icon}</span>
    ${t.badge?'<div class="tab-badge"></div>':""}
    <span style="font-size:11px;font-weight:${state.view===t.key?700:400};color:${state.view===t.key?T.dark:"#aaa"}">${t.label}</span>
  </button>`).join("")}</div>`;
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(){
  let content="";
  if(state.view==="home") content=renderHome();
  else if(state.view==="session") content=renderSession();
  else if(state.view==="progress") content=renderProgress();
  else if(state.view==="nutrition") content=renderNutrition();
  document.getElementById("app").innerHTML=content+renderTabBar()+renderLogSheet()+renderTipsSheet();
  const st=document.getElementById("shoulder-toggle");
  if(st) st.addEventListener("click",()=>{ const s=!state.shoulderFlag; persist(SK.shoulder,s); setState({shoulderFlag:s}); });
}

// â”€â”€ ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setView(v){ setState({view:v,activeDay:v!=="session"?null:state.activeDay}); }
function setWeek(w){ persist(SK.week,w); setState({weekNum:w}); }
function openDay(key){ setState({view:"session",activeDay:key}); }
function finishSession(key){ const c={...state.completed,[key]:true}; persist(SK.completed,c); setState({completed:c,view:"home",activeDay:null}); }

function toggleExercise(dayKey,exIdx){
  const ex=DAYS[dayKey].exercises[exIdx];
  const logs={...state.sessionLogs};
  if(logs[ex.id]){
    // undo â€” remove the log entry
    delete logs[ex.id];
    setState({sessionLogs:logs});
  } else {
    // not yet logged â€” open the log sheet
    openLog(dayKey,exIdx);
  }
}
function openLog(dayKey,exIdx){
  const ex=DAYS[dayKey].exercises[exIdx], pre=getPreFill(ex.id);
  const logs={...state.sessionLogs};
  if(!logs[ex.id]) logs[ex.id]={w:pre.w,r:pre.r};
  setState({logSheet:{dayKey,exIdx},sessionLogs:logs});
}
function closeLog(){ setState({logSheet:null}); }
function adjLog(field,delta){
  const {dayKey,exIdx}=state.logSheet;
  const ex=DAYS[dayKey].exercises[exIdx];
  const logs={...state.sessionLogs};
  const cur=logs[ex.id]||{w:0,r:0};
  logs[ex.id]={...cur,[field]:Math.max(0,Number(cur[field]||0)+delta)};
  setState({sessionLogs:logs});
}
function saveLog(){
  const {dayKey,exIdx}=state.logSheet;
  const ex=DAYS[dayKey].exercises[exIdx], entry=state.sessionLogs[ex.id];
  if(entry){ const h={...state.history,[ex.id]:[...(state.history[ex.id]||[]),{w:Number(entry.w),r:Number(entry.r)}]}; persist(SK.history,h); setState({history:h,logSheet:null}); }
  else setState({logSheet:null});
}
function openTips(exId){
  const ex=Object.values(DAYS).flatMap(d=>d.exercises).find(e=>e.id===exId);
  if(ex) setState({tipsSheet:ex});
}
function closeTips(){ setState({tipsSheet:null}); }
function toggleChart(id){ setState({chartEx:state.chartEx===id?null:id}); }
function logBW(){ const v=parseFloat(document.getElementById("bw-input")?.value); if(!isNaN(v)&&v>0){ const bw=[...state.bodyweight,v]; persist(SK.bw,bw); setState({bodyweight:bw}); } }
function toggleNut(id){ const nc={...state.nutChecks,[id]:!state.nutChecks[id]}; persist(SK.nutChecks,nc); setState({nutChecks:nc}); }
function toggleMeal(id){ const mc={...state.mealChecks,[id]:!state.mealChecks[id]}; persist(SK.mealChecks,mc); setState({mealChecks:mc}); }

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
render();
</script>
</body>
</html>
